<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Map</title>
  <style>
    :root {
      --bg: #0c1017;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #3b82f6;
      --border: #1f2937;
      --nav: #1a2535;
      --nav-top: #40576f;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(120% 120% at 30% 20%, #111827 0%, #0b0f18 50%, #0a0d14 100%);
      color: var(--text);
      font-family: "Segoe UI", system-ui, sans-serif;
    }
    a { color: var(--text); text-decoration: none; }
    a:hover { color: #93c5fd; }
    .container { max-width:1900px; margin:0 auto; padding:0 20px; }
    .topbar { background: var(--nav-top); color:#dbeafe; font-size:13px; }
    .topbar .container { display:flex; justify-content:space-between; padding:6px 0; }
    .navbar { background: var(--nav); color:#dbeafe; border-bottom:1px solid #223144; }
    .navbar .container { display:flex; align-items:center; gap:20px; padding:14px 0; }
    .brand { font-weight:800; font-size:20px; letter-spacing:0.5px; display:flex; align-items:center; gap:8px; }
    .nav-links a { margin-right:16px; font-weight:600; }
    .subnav { background: var(--nav-top); color:#dbeafe; }
    .subnav .container { padding:10px 0; font-weight:600; }
    .layout { max-width:1900px; margin:16px auto; padding:0 20px 20px; }
    #ui {
      padding: 10px 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    a.button {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      text-decoration: none;
      color: var(--text);
      background: #0f172a;
    }
    a.button:hover { border-color: var(--accent); color: var(--accent); }
    select {
      background: #0f172a;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 8px;
    }
    #legend { display:flex; gap:8px; align-items:center; font-size:12px; color: var(--muted); }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
    #status { color: var(--muted); font-size: 13px; }
    #tooltip {
      position: fixed;
      pointer-events: none;
      padding: 6px 8px;
      background: #0f172a;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      display: none;
      z-index: 20;
    }
    #map {
      display: block;
      width: 100%;
      height: 720px;
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #0a0d14;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div>Top Link 1 &nbsp;|&nbsp; Top Link 2</div>
      <div>Found a bug? Let us know</div>
    </div>
  </div>
  <div class="navbar">
    <div class="container">
      <div class="brand">EVE Sheets</div>
      <div class="nav-links">
        <a href="index.html">System stats</a>
        <a href="lp.html">LP Shop</a>
        <a href="map.html" style="color:#93c5fd;">Map</a>
      </div>
    </div>
  </div>
  <div class="subnav">
    <div class="container">Subnav 1 &nbsp; Subnav 2 &nbsp; Subnav 3 &nbsp; Subnav 4</div>
  </div>

  <div class="layout">
    <div id="ui">
      <a class="button" href="index.html">← Back</a>
      <label for="regionSelect" style="color:var(--muted); font-size:12px;">Region:</label>
      <select id="regionSelect"></select>
      <div id="legend">
        <span class="dot" style="background:#22c55e"></span> HS
        <span class="dot" style="background:#facc15"></span> LS
        <span class="dot" style="background:#ef4444"></span> NS
      </div>
      <div id="status">Loading...</div>
    </div>
    <canvas id="map"></canvas>
  </div>
  <div id="tooltip"></div>

  <script type="module">
    const canvas = document.getElementById("map");
    const ctx = canvas.getContext("2d");
    const statusEl = document.getElementById("status");
    const tooltip = document.getElementById("tooltip");
    const regionSelect = document.getElementById("regionSelect");
    const wrap = document.querySelector(".layout");

    let dataNodes = [];
    let dataEdges = [];
    let nodesToRender = [];
    let edgesToRender = [];
    let viewBox = { x: 0, y: 0, w: 1, h: 1 };
    const logoCache = new Map(); // allianceId -> {img, loaded}

    const colors = {
      HS: "#22c55e",
      LS: "#facc15",
      NS: "#ef4444",
      line: "#374151"
    };

    function loadJSON(url) {
      return fetch(url).then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      });
    }

    function populateRegions(nodes) {
      const regionNames = Array.from(new Set(nodes.map(n => n.region))).sort((a, b) => a.localeCompare(b));
      regionSelect.innerHTML = `<option value="all">All regions</option>` +
        regionNames.map(r => `<option value="${r}">${r}</option>`).join("");
      if (regionNames.includes("Aridia")) regionSelect.value = "Aridia";
    }

    function resize() {
      const w = wrap.clientWidth;
      const h = 720;
      canvas.width = w;
      canvas.height = h;
      draw();
    }
    window.addEventListener("resize", resize);

    function fitRegion(nodes) {
      const xs = nodes.map(n => n.rawX);
      const ys = nodes.map(n => n.rawZ);
      const minX = Math.min(...xs), maxX = Math.max(...xs);
      const minY = Math.min(...ys), maxY = Math.max(...ys);
      const pad = 0.08;
      const w = maxX - minX || 1;
      const h = maxY - minY || 1;
      viewBox = {
        x: minX - w * pad,
        y: minY - h * pad,
        w: w * (1 + pad * 2),
        h: h * (1 + pad * 2)
      };
    }

    function project(node) {
      const x = ((node.rawX - viewBox.x) / viewBox.w) * canvas.width;
      const y = ((node.rawZ - viewBox.y) / viewBox.h) * canvas.height;
      return { x, y };
    }

    function ensureLogo(allianceId) {
      if (!allianceId) return null;
      if (logoCache.has(allianceId)) return logoCache.get(allianceId);
      const img = new Image();
      img.src = `https://image.eveonline.com/Alliance/${allianceId}_32.png`;
      const entry = { img, loaded: false };
      img.onload = () => { entry.loaded = true; draw(); };
      img.onerror = () => { entry.loaded = false; };
      logoCache.set(allianceId, entry);
      return entry;
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#0a0d14";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // edges
      ctx.strokeStyle = colors.line;
      ctx.lineWidth = 1;
      ctx.globalAlpha = 0.4;
      ctx.beginPath();
      const nodeMap = new Map(nodesToRender.map(n => [n.id, n]));
      for (const [a, b] of edgesToRender) {
        const A = nodeMap.get(a);
        const B = nodeMap.get(b);
        if (!A || !B) continue;
        const p1 = project(A);
        const p2 = project(B);
        ctx.moveTo(p1.x, p1.y);
        ctx.lineTo(p2.x, p2.y);
      }
      ctx.stroke();
      ctx.globalAlpha = 1;

      // nodes
      const radius = 6;
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      ctx.font = "12px Segoe UI, sans-serif";

      for (const n of nodesToRender) {
        const p = project(n);
        ctx.fillStyle = colors[n.classTag] || colors.NS;
        ctx.beginPath();
        ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);
        ctx.fill();

        const label = n.topCorpName
          ? n.topAllianceTicker
            ? `${n.name} — ${n.topCorpName} (${n.topAllianceTicker})`
            : `${n.name} — ${n.topCorpName}`
          : n.name;

        const textX = p.x + radius + 6;
        ctx.fillStyle = "#e5e7eb";
        ctx.fillText(label, textX, p.y);

        if (n.topAllianceId) {
          const logo = ensureLogo(n.topAllianceId);
          if (logo && logo.loaded) {
            ctx.drawImage(logo.img, textX + ctx.measureText(label).width + 6, p.y - 10, 20, 20);
          }
        }
      }
    }

    function handleHover(evt) {
      const rect = canvas.getBoundingClientRect();
      const mx = evt.clientX - rect.left;
      const my = evt.clientY - rect.top;
      const radiusSq = 8 * 8;
      for (const n of nodesToRender) {
        const p = project(n);
        const dx = p.x - mx;
        const dy = p.y - my;
        if (dx * dx + dy * dy <= radiusSq) {
          tooltip.style.display = "block";
          tooltip.style.left = evt.clientX + 12 + "px";
          tooltip.style.top = evt.clientY + 12 + "px";
          tooltip.innerHTML = `${n.name}<br>${n.region}`;
          return;
        }
      }
      tooltip.style.display = "none";
    }
    canvas.addEventListener("mousemove", handleHover);

    function renderRegion(region) {
      nodesToRender = region === "all" ? dataNodes : dataNodes.filter(n => n.region === region);
      const idSet = new Set(nodesToRender.map(n => n.id));
      edgesToRender = dataEdges.filter(([a, b]) => idSet.has(a) && idSet.has(b));
      fitRegion(nodesToRender);
      statusEl.textContent = `Systems: ${nodesToRender.length}, links: ${edgesToRender.length}`;
      draw();
    }

    async function init() {
      try {
        const { nodes, edges } = await loadJSON("/json/map_data.json");
        dataNodes = nodes || [];
        dataEdges = edges || [];
        populateRegions(dataNodes);
        resize();
        renderRegion(regionSelect.value || "all");
        regionSelect.onchange = () => renderRegion(regionSelect.value);
      } catch (err) {
        console.error(err);
        statusEl.textContent = `Error: ${err.message}`;
      }
    }

    init();
  </script>
</body>
</html>
