<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>System stats</title>
  <style>
    :root {
      --bg: #0c1017;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #3b82f6;
      --border: #1f2937;
      --nav: #1a2535;
      --nav-top: #40576f;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      background: radial-gradient(120% 120% at 30% 20%, #111827 0%, #0b0f18 50%, #0a0d14 100%);
      color: var(--text);
      overflow-y: scroll;
    }
    a { color: var(--text); text-decoration: none; }
    a:hover { color: #93c5fd; }
    .container { max-width:1900px; margin:0 auto; padding:0 20px; }
    .topbar { background: var(--nav-top); color:#dbeafe; font-size:13px; }
    .topbar .container { display:flex; justify-content:space-between; padding:6px 0; }
    .navbar { background: var(--nav); color:#dbeafe; border-bottom:1px solid #223144; }
    .navbar .container { display:flex; align-items:center; gap:20px; padding:14px 0; }
    .brand { font-weight:800; font-size:20px; letter-spacing:0.5px; display:flex; align-items:center; gap:8px; }
    .nav-links a { margin-right:16px; font-weight:600; }
    .subnav { background: var(--nav-top); color:#dbeafe; }
    .subnav .container { padding:10px 0; font-weight:600; }
    .layout { max-width:1900px; margin:24px auto; padding:0 20px; }
    .page { display:grid; grid-template-columns: repeat(12, minmax(0, 1fr)); gap:16px; }
    h1 { margin: 0 0 8px 0; font-size: 24px; }
    .muted { color: var(--muted); font-size: 14px; }
    .panel {
      grid-column: span 12;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.35);
    }
    .controls { display:flex; gap:12px; align-items:center; margin:12px 0 10px; flex-wrap: wrap; }
    .filters { display:flex; gap:8px; flex-wrap: wrap; margin-bottom: 8px; }
    input[type="search"] {
      background: #0f172a;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      min-width: 240px;
    }
    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { filter: brightness(1.05); }
    .chip {
      border: 1px solid var(--border);
      background: #0f172a;
      color: var(--text);
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    .chip.active { border-color: var(--accent); color: var(--accent); }
    table.data-table { width: 100%; border-collapse: collapse; font-size: 14px; font-variant-numeric: tabular-nums; }
    table.data-table thead th { font-size:12px; text-transform:uppercase; letter-spacing:.06em; color: var(--muted); font-weight:700; padding:10px 8px; position: sticky; top: 0; background: rgba(15,23,42,0.35); z-index:3; }
    table.data-table th, table.data-table td { text-align: left; padding: 12px 8px; border-bottom: 1px solid rgba(255,255,255,0.06); white-space: nowrap; }
    table.data-table th.sortable { cursor: pointer; user-select: none; }
    table.data-table tbody tr { cursor: pointer; }
    table.data-table tbody tr:hover td { background: rgba(255,255,255,0.035); }
    table.data-table td[data-col]:not([data-col="system"]):not([data-col="region"]):not([data-col="security"]):not([data-col="topCorp"]):not([data-col="allianceLogo"]) { text-align:right; }
    table.data-table .sticky-col { position: sticky; left: 0; background: transparent; z-index:2; }
    table.data-table thead th.sticky-col { z-index: 4; }
    .pill { padding: 4px 8px; border-radius: 999px; font-weight: 600; display: inline-block; }
    .status { font-size: 13px; color: var(--muted); }
    .table-wrap { overflow-x:auto; overflow-y:visible; max-height:none; }
    .logo { height: 32px; width: 32px; border-radius: 4px; background: #0f172a; object-fit: contain; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div>Top Link 1 &nbsp;|&nbsp; Top Link 2</div>
      <div>Found a bug? Let us know</div>
    </div>
  </div>
  <div class="navbar">
    <div class="container">
      <div class="brand">EVE Sheets</div>
      <div class="nav-links">
        <a href="index.html" style="color:#93c5fd;">System stats</a>
        <a href="lp.html">LP Shop</a>
      </div>
      <div style="flex:1"></div>
    </div>
  </div>
  <div class="subnav">
    <div class="container">Subnav 1 &nbsp; Subnav 2 &nbsp; Subnav 3 &nbsp; Subnav 4</div>
  </div>

  <div class="layout">
    <div class="page">
      <div class="panel">
        <h1>System stats (zKB)</h1>
        <div class="muted">System / Region / Security / Kills / ISK / Top corp &amp; alliance.</div>

        <div class="controls">
          <input type="search" id="search" placeholder="Search: system or region" />
          <a href="lp.html"><button type="button">LP Shop</button></a>
          <button type="button" id="colsBtn">Columns</button>
          <div style="display:flex; gap:6px; align-items:center;">
            <button type="button" class="range-btn" data-range="d7">7d</button>
            <button type="button" class="range-btn" data-range="d30">30d</button>
            <button type="button" class="range-btn" data-range="all">ALL</button>
          </div>
          <button id="reload">Refresh</button>
          <span class="status" id="status">Loading...</span>
        </div>

        <div class="filters" id="classFilters"></div>

        <div class="table-wrap">
          <table class="data-table">
            <thead>
              <tr>
                <th data-col="row">#</th>
                <th class="sortable sticky-col" data-sort="name" data-label="System" data-col="system">System</th>
                <th class="sortable" data-sort="region" data-label="Region" data-col="region">Region</th>
                <th data-col="security">Security</th>
                <th class="sortable" data-sort="kills" data-label="Kills" data-col="kills">Kills</th>
                <th class="sortable" data-sort="isk" data-label="ISK" data-col="isk">ISK</th>
                <th data-col="topCorp">Top corp (alliance)</th>
                <th data-col="allianceLogo">Alliance logo</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="columns.js"></script>
  <script type="module">
    const colsBtn = document.getElementById("colsBtn");
    const statusEl = document.getElementById("status");
    const tbody = document.getElementById("tableBody");
    const tableEl = document.querySelector(".table-wrap table");
    const searchEl = document.getElementById("search");
    const reloadBtn = document.getElementById("reload");
    const classFiltersEl = document.getElementById("classFilters");
    const headerEls = Array.from(document.querySelectorAll("th[data-sort]"));
    const rangeButtons = Array.from(document.querySelectorAll(".range-btn"));

    const numberFmt = new Intl.NumberFormat("ru-RU");
    let cachedRows = [];
    let activeClasses = new Set(["HS","LS","NS","C1","C2","C3","C4","C5","C6"]);
    let sortState = { key: "kills", dir: "desc" };
    let range = "d7";

    const columnsMgr = window.initColumnManager({
      table: tableEl,
      storageKey: "systems_cols_v1",
      button: colsBtn,
      columns: [
        { id: "row", label: "#", group: "Main", locked: true },
        { id: "system", label: "System", group: "Main", locked: true },
        { id: "region", label: "Region", group: "Main" },
        { id: "security", label: "Security", group: "Main" },
        { id: "kills", label: "Kills", group: "zKB" },
        { id: "isk", label: "ISK", group: "zKB" },
        { id: "topCorp", label: "Top corp", group: "zKB" },
        { id: "allianceLogo", label: "Alliance logo", group: "zKB" },
      ],
    });

    const iskFmt = (value = 0) => {
      if (value >= 1e12) return (value / 1e12).toFixed(2) + " T";
      if (value >= 1e9) return (value / 1e9).toFixed(2) + " B";
      if (value >= 1e6) return (value / 1e6).toFixed(1) + " M";
      return numberFmt.format(Math.round(value));
    };

    const secPalette = [
      "#a43d7f","#d33b56","#ff4d3d","#ff8a30","#ffb037",
      "#ffd93b","#a5ec4d","#53e57f","#3bd7c3","#3bc5ff",
      "#33a1ff","#2f80ed"
    ];
    function securityPill(sec) {
      if (sec === undefined || sec === null) return '<span class="pill" style="background:#facc151f; color:#facc15">?</span>';
      const clamped = Math.max(-1, Math.min(1, sec));
      const idx = Math.round(((clamped + 1) / 2) * (secPalette.length - 1));
      const color = secPalette[idx] || "#a43d7f";
      return `<span class="pill" style="background:${color}1f; color:${color}">${sec.toFixed(2)}</span>`;
    }

    async function loadJSON(url, label) {
      statusEl.textContent = `Loading ${label || url}...`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Failed to load ${label || url}: ${res.status}`);
      return res.json();
    }

    function renderRows(rows, query = "", active, sortState) {
      const q = query.trim().toLowerCase();
      const filtered = rows
        .filter(r => (r.kills?.[range] ?? r.kills ?? 0) >= 50)
        .filter(r => active.has(r.classTag))
        .filter(r => !q || r.name.toLowerCase().includes(q) || (r.region || "").toLowerCase().includes(q));

      const sorted = [...filtered].sort((a, b) => {
        const dir = sortState.dir === "asc" ? 1 : -1;
        if (sortState.key === "name") return a.name.localeCompare(b.name) * dir;
        if (sortState.key === "region") return (a.region || "").localeCompare(b.region || "") * dir;
        if (sortState.key === "isk") return ((a.isk?.[range] ?? a.isk ?? 0) - (b.isk?.[range] ?? b.isk ?? 0)) * dir;
        return ((a.kills?.[range] ?? a.kills ?? 0) - (b.kills?.[range] ?? b.kills ?? 0)) * dir;
      });

      tbody.innerHTML = "";
      const frag = document.createDocumentFragment();

      for (let i = 0; i < sorted.length; i++) {
        const row = sorted[i];
        const corpLabel = row.topCorpName
          ? row.topAllianceTicker
            ? `${row.topCorpName} (${row.topAllianceTicker})`
            : row.topCorpName
          : "—";
        const logoCell = row.topAllianceId
          ? `<img class="logo" src="https://image.eveonline.com/Alliance/${row.topAllianceId}_64.png" referrerpolicy="no-referrer" alt="${row.topAllianceTicker || "Alliance"}">`
          : "—";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td data-col="row">${i + 1}</td>
          <td data-col="system" class="sticky-col">${row.name}</td>
          <td data-col="region">${row.region}</td>
          <td data-col="security">${securityPill(row.security)}</td>
          <td data-col="kills">${numberFmt.format(row.kills?.[range] ?? row.kills ?? 0)}</td>
          <td data-col="isk">${iskFmt(row.isk?.[range] ?? row.isk ?? 0)}</td>
          <td data-col="topCorp">${corpLabel}</td>
          <td data-col="allianceLogo">${logoCell}</td>
        `;
        frag.appendChild(tr);
      }

      tbody.appendChild(frag);
      if (columnsMgr) columnsMgr.apply();
      statusEl.textContent = `Showing ${sorted.length} of ${rows.length} (>=50 kills), period: ${range}`;
      updateHeaderLabels();
    }

    function renderClassFilters(activeSet, onToggle) {
      const tags = ["HS", "LS", "NS", "C1", "C2", "C3", "C4", "C5", "C6"];
      classFiltersEl.innerHTML = "";
      for (const tag of tags) {
        const btn = document.createElement("button");
        btn.className = "chip" + (activeSet.has(tag) ? " active" : "");
        btn.textContent = tag;
        btn.onclick = () => onToggle(tag);
        classFiltersEl.appendChild(btn);
      }
    }

    function updateHeaderLabels() {
      headerEls.forEach(th => {
        const key = th.dataset.sort;
        const base = th.dataset.label || th.textContent;
        const arrow = key === sortState.key ? (sortState.dir === "asc" ? " ↑" : " ↓") : "";
        th.textContent = base + arrow;
        th.dataset.label = base;
      });
      rangeButtons.forEach(btn => {
        const active = btn.dataset.range === range;
        btn.style.background = active ? "#1e3a8a" : "var(--accent)";
        btn.style.borderColor = active ? "#3b82f6" : "var(--border)";
      });
    }

    function setupHeaderSorting() {
      headerEls.forEach(th => {
        th.addEventListener("click", () => {
          const key = th.dataset.sort;
          const dir = sortState.key === key && sortState.dir === "desc" ? "asc" : "desc";
          sortState = { key, dir };
          rerender();
        });
      });
      updateHeaderLabels();
    }

    const rerender = () => renderRows(cachedRows, searchEl.value, activeClasses, sortState);

    async function loadAndRender() {
      try {
        const { systems } = await loadJSON("/json/system_table.json", "system table");
        cachedRows = systems || [];
        rerender();

        searchEl.oninput = rerender;
        reloadBtn.onclick = () => {
          statusEl.textContent = "Refreshing...";
          loadAndRender();
        };
      } catch (err) {
        console.error(err);
        statusEl.textContent = err.message;
      }
    }

    function setupClassFilters() {
      const handle = tag => {
        if (activeClasses.has(tag)) activeClasses.delete(tag);
        else activeClasses.add(tag);
        renderClassFilters(activeClasses, handle);
        rerender();
      };
      renderClassFilters(activeClasses, handle);
    }

    setupClassFilters();
    setupHeaderSorting();
    rangeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        range = btn.dataset.range;
        updateHeaderLabels();
        rerender();
      });
    });
    loadAndRender();
  </script>
</body>
</html>
