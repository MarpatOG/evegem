<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LP Shop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #0c1017;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --nav: #1a2535;
      --nav-top: #40576f;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: "Segoe UI", system-ui, -apple-system, sans-serif; background: radial-gradient(120% 120% at 30% 20%, #111827 0%, #0b0f18 50%, #0a0d14 100%); color: var(--text); overflow-y: scroll; }
    a { color: var(--text); text-decoration: none; }
    a:hover { color: #93c5fd; }

    .container { max-width:1900px; margin:0 auto; padding:0 20px; }
    .topbar { background: var(--nav-top); color:#dbeafe; font-size:13px; }
    .topbar .container { display:flex; justify-content:space-between; padding:6px 0; }
    .navbar { background: var(--nav); color:#dbeafe; border-bottom:1px solid #223144; }
    .navbar .container { display:flex; align-items:center; gap:20px; padding:14px 0; }
    .brand { font-weight:800; font-size:20px; letter-spacing:0.5px; }
    .nav-links a { margin-right:16px; font-weight:600; }
    .subnav { background: var(--nav-top); color:#dbeafe; }
    .subnav .container { padding:10px 0; font-weight:600; display:flex; gap:16px; flex-wrap:wrap; }
    .subnav a { color:#dbeafe; opacity:0.9; }
    .subnav a.active { color:#fff; opacity:1; text-decoration: underline; text-underline-offset: 4px; }

    .shell { max-width:1900px; margin:24px auto; padding:0 20px; display:grid; grid-template-columns: 1fr; gap:16px; align-items:start; }
    .sidebar { display:none; }
    .main { display:flex; justify-content:center; }
    .main-inner { width:min(1900px, 100%); }
    @media (max-width: 1200px) { .shell { grid-template-columns: 1fr; } .main { justify-content:stretch; } .main-inner { width:100%; } }

    .page { display:grid; grid-template-columns: repeat(12, minmax(0, 1fr)); gap:16px; }
    .panel { grid-column: span 12; background: var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; box-shadow:0 10px 40px rgba(0,0,0,0.35); }
    .panel h1 { margin:0 0 4px 0; font-size:22px; }
    .muted { color: var(--muted); font-size:14px; margin-bottom:12px; }

    .sidebar h2 { margin:0 0 10px 0; font-size:16px; }
    .field { margin-bottom:10px; }
    .field label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .input, .select { width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--border); background:#0f172a; color:var(--text); }
    .controls .select { width:auto; }
    .row { display:flex; gap:10px; }
    .row .field { flex:1; }
    .check { display:flex; align-items:center; gap:8px; color:var(--text); font-size:14px; }

    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:0 0 12px; }
    .control-spacer { flex: 1; }
    .btn { padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#0f172a; color:var(--text); font-weight:700; cursor:pointer; }
    .btn:hover { color:#bfdbfe; }
    .action-btn { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#0f172a; color:var(--text); font-weight:900; font-size:12px; cursor:pointer; }
    .action-btn:hover { color:#bfdbfe; }
    .dropdown { position: relative; display:inline-block; }
    .dropdown-panel { position:absolute; right:0; top:calc(100% + 8px); width: 260px; background:#111827; border:1px solid var(--border); border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,.55); padding:10px; display:none; z-index: 60; }
    .dropdown-panel .opt { display:flex; justify-content:space-between; align-items:center; padding:10px 10px; border-radius:10px; cursor:pointer; font-weight:800; }
    .dropdown-panel .opt:hover { background:#0b1220; }
    .dropdown-panel .check { opacity:0.8; }
    .dropdown-panel .range { display:flex; gap:10px; padding:10px 8px 2px; }
    .dropdown-panel .range input { flex:1; padding:10px 10px; border-radius:10px; border:1px solid var(--border); background:#0b1220; color:var(--text); }
    .dropdown-panel .foot { display:flex; justify-content:space-between; align-items:center; padding:10px 8px 2px; }
    .dropdown-panel .link { background:transparent; border:0; color:#93c5fd; cursor:pointer; font-weight:900; }
    .dropdown-panel .apply { padding:8px 12px; border-radius:10px; border:1px solid #1d4ed8; background:#2563eb; color:#fff; cursor:pointer; font-weight:900; }
    .table-wrap { overflow-x:auto; overflow-y:visible; max-height:none; }
    table.data-table { width:100%; border-collapse:collapse; font-size:14px; font-variant-numeric: tabular-nums; }
    table.data-table thead th { font-size:12px; text-transform:uppercase; letter-spacing:.06em; color: var(--muted); font-weight:700; padding:10px 8px; background: rgba(15,23,42,0.35); position:sticky; top:0; z-index:3; }
    table.data-table th, table.data-table td { padding:12px 8px; border-bottom:1px solid rgba(255,255,255,0.06); white-space:nowrap; }
    table.data-table th.sortable { cursor:pointer; user-select:none; }
    table.data-table th.sortable:hover { color:#bfdbfe; }
    table.data-table tbody tr { cursor:pointer; }
    table.data-table tbody tr:hover td { background: rgba(255,255,255,0.035); }
    table.data-table td[data-col]:not([data-col="corp"]):not([data-col="tags"]):not([data-col="faction"]) { text-align:right; }
    table.data-table td[data-col="corp"], table.data-table td[data-col="faction"], table.data-table td[data-col="tags"] { text-align:left; }

    table.data-table .sticky-col { position: sticky; left: 0; background: transparent; z-index:2; }
    table.data-table thead th.sticky-col { z-index: 4; }
    table.data-table .key { font-weight:700; color:#93c5fd; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#1f2937; font-weight:600; font-size:12px; }
    .tag-cloud { display:inline-flex; gap:8px; flex-wrap:wrap; }
    .pill.tag { border:1px solid var(--border); background: transparent; font-weight:700; padding:2px 6px; }
    .pill.tag-hs { background: transparent; border-color: rgba(34,197,94,0.55); color: rgba(34,197,94,0.95); }
    .pill.tag-ls { background: transparent; border-color: rgba(250,204,21,0.45); color: rgba(250,204,21,0.95); }
    .pill.tag-ns { background: transparent; border-color: rgba(239,68,68,0.45); color: rgba(239,68,68,0.95); }
    .pill.tag-empire { background: transparent; border-color: rgba(59,130,246,0.45); color: rgba(147,197,253,0.95); }
    .pill.tag-pirate { background: transparent; border-color: rgba(168,85,247,0.45); color: rgba(216,180,254,0.95); }
    .pill.tag-l5 { background: transparent; border-color: rgba(249,115,22,0.45); color: rgba(253,186,116,0.95); }
    .pill.tag-fw { background: transparent; border-color: rgba(168, 85, 247, 0.55); color: rgba(216,180,254,0.95); }
    .logo { width:28px; height:28px; border-radius:4px; background:#0f172a; object-fit:contain; vertical-align:middle; margin-right:8px; }
    th[data-col="corp"], td[data-col="corp"] { padding-right:4px; }
    th[data-col="tags"], td[data-col="tags"] { padding-left:4px; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div>Top Link 1 &nbsp;|&nbsp; Top Link 2</div>
      <div>Found a bug? Let us know</div>
    </div>
  </div>
  <div class="navbar">
    <div class="container">
      <div class="brand">EVE Sheets</div>
      <div class="nav-links">
        <a href="index.html">System stats</a>
        <a href="lp.html" style="color:#93c5fd;">LP Shop</a>
      </div>
      <div style="flex:1"></div>
    </div>
  </div>
  <div class="subnav">
    <div class="container">
      <a href="lp.html" class="active">Corporations</a>
      <a href="lp_items.html">Items</a>
      <span style="opacity:.6">Subnav 3</span>
      <span style="opacity:.6">Subnav 4</span>
    </div>
  </div>

  <div class="shell">
    <div class="main">
      <div class="main-inner">
        <div class="page">
          <div class="panel">
            <h1>LP Shop Corporations</h1>
            <div class="muted">List of LP corporations with unique items and ISK/LP performance.</div>
            <div class="controls">
              <select id="faction" class="select" style="min-width:220px;">
                <option value="">All factions</option>
              </select>
              <div class="control-spacer"></div>
              <div class="dropdown" id="tagDropdown">
                <button class="action-btn" id="tagBtn" type="button">Tag Filter</button>
                <div class="dropdown-panel" id="tagPanel">
                  <div class="opt" data-tag="Empire"><span class="pill tag tag-empire">Empire</span><span class="check" data-check="Empire"></span></div>
                  <div class="opt" data-tag="Pirate"><span class="pill tag tag-pirate">Pirate</span><span class="check" data-check="Pirate"></span></div>
                  <div class="opt" data-tag="FW"><span class="pill tag tag-fw">FW</span><span class="check" data-check="FW"></span></div>
                  <div class="opt" data-tag="HS"><span class="pill tag tag-hs">HS</span><span class="check" data-check="HS"></span></div>
                  <div class="opt" data-tag="LS"><span class="pill tag tag-ls">LS</span><span class="check" data-check="LS"></span></div>
                  <div class="opt" data-tag="NS"><span class="pill tag tag-ns">NS</span><span class="check" data-check="NS"></span></div>
                  <div class="opt" data-tag="LVL 5"><span class="pill tag tag-l5">LVL 5</span><span class="check" data-check="LVL 5"></span></div>
                  <div class="foot">
                    <button class="link" type="button" id="tagReset">Reset</button>
                    <button class="apply" type="button" id="tagApply">Apply</button>
                  </div>
                </div>
              </div>
              <div class="dropdown" id="isklpDropdown">
                <button class="action-btn" id="isklpBtn" type="button">ISK/LP</button>
                <div class="dropdown-panel" id="isklpPanel">
                  <div class="opt" data-preset="any"><span>Any</span><span class="check" data-check="any"></span></div>
                  <div class="opt" data-preset="1000"><span>&ge; 1000</span><span class="check" data-check="1000"></span></div>
                  <div class="opt" data-preset="2000"><span>&ge; 2000</span><span class="check" data-check="2000"></span></div>
                  <div class="opt" data-preset="3000"><span>&ge; 3000</span><span class="check" data-check="3000"></span></div>
                  <div class="range">
                    <input id="isklpMinBox" placeholder="Min">
                    <input id="isklpMaxBox" placeholder="Max">
                  </div>
                  <div class="foot">
                    <button class="link" type="button" id="isklpReset">Reset</button>
                    <button class="apply" type="button" id="isklpApply">Apply</button>
                  </div>
                </div>
              </div>
              <button class="action-btn" id="columnsBtn" type="button">Columns</button>
            </div>
            <div class="table-wrap">
              <table id="table" class="data-table">
                <thead>
                  <tr>
                    <th data-col="row">#</th>
                    <th class="sortable sticky-col" data-sort="name" data-col="corp">Corporation</th>
                    <th class="sortable" data-sort="tags" data-col="tags">Tags</th>
                    <th class="sortable" data-sort="agents" data-col="agents">Agents</th>
                    <th class="sortable" data-sort="corpId" data-col="corpId">Corp ID</th>
                    <th class="sortable" data-sort="best" data-col="best">Best ISK/LP</th>
                    <th class="sortable" data-sort="median" data-col="median">Median ISK/LP</th>
                    <th class="sortable" data-sort="unique" data-col="unique">Unique items</th>
                    <th class="sortable" data-sort="offers" data-col="offers">Offers</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="columns.js"></script>
  <script>
    const tbody = document.querySelector("tbody");
    const tableEl = document.querySelector("table");
    const factionEl = document.getElementById("faction");
    const tagBtn = document.getElementById("tagBtn");
    const tagPanel = document.getElementById("tagPanel");
    const tagResetBtn = document.getElementById("tagReset");
    const tagApplyBtn = document.getElementById("tagApply");
    const isklpBtn = document.getElementById("isklpBtn");
    const isklpPanel = document.getElementById("isklpPanel");
    const isklpResetBtn = document.getElementById("isklpReset");
    const isklpApplyBtn = document.getElementById("isklpApply");
    const isklpMinBox = document.getElementById("isklpMinBox");
    const isklpMaxBox = document.getElementById("isklpMaxBox");

    let corps = [];
    let corpConfig = { corps: {} };
    let agentsByCorp = {};
    const columnsBtn = document.getElementById("columnsBtn");

    const columnsMgr = window.initColumnManager({
      table: tableEl,
      storageKey: "lp_corps_cols_v1",
      button: columnsBtn,
      columns: [
        { id: "row", label: "#", group: "Main", locked: true },
        { id: "corp", label: "Corporation", group: "Main", locked: true },
        { id: "tags", label: "Tags", group: "Main" },
        { id: "agents", label: "Agents", group: "Agents" },
        { id: "corpId", label: "Corp ID", group: "IDs", defaultVisible: false },
        { id: "best", label: "Best ISK/LP", group: "Economy" },
        { id: "median", label: "Median ISK/LP", group: "Economy" },
        { id: "unique", label: "Unique items", group: "LP" },
        { id: "offers", label: "Offers", group: "LP" },
      ],
    });

    function isklpColor(v) {
      if (v == null || !Number.isFinite(v)) return null;
      if (v >= 1201) return "#3399FF";
      if (v >= 951) return "#FFFF66";
      if (v >= 751) return "#FF8C00";
      if (v >= 651) return "#FF4D4D";
      if (v >= 501) return "#C00000";
      return "#8B0000";
    }

    function isklpSpan(v) {
      if (v == null || !Number.isFinite(v)) return "-";
      const c = isklpColor(v);
      return `<span style="color:${c}; font-weight:800;">${Number(v).toFixed(0)}</span>`;
    }
    let sortState = { key: "name", dir: "asc" };

    function buildFactionOptions() {
      const factions = Array.from(new Set(corps.map(c => (c.type || c.faction || "").trim()).filter(Boolean))).sort();
      for (const f of factions) {
        const opt = document.createElement("option");
        opt.value = f;
        opt.textContent = f;
        factionEl.appendChild(opt);
      }
    }

    function inferPirateOrEmpire(label) {
      const s = String(label || "").toLowerCase();
      if (!s) return null;
      const pirateKeys = [
        "guristas",
        "sansha",
        "serpentis",
        "blood",
        "angel",
        "mordu",
        "thukker",
        "pirate",
      ];
      const empireKeys = [
        "amarr",
        "caldari",
        "gallente",
        "minmatar",
        "empire",
        "state",
        "federation",
        "republic",
      ];
      if (pirateKeys.some((k) => s.includes(k))) return "Pirate";
      if (empireKeys.some((k) => s.includes(k))) return "Empire";
      return "Empire";
    }

    function countZoneAgents(zoneMatrix) {
      if (!zoneMatrix || typeof zoneMatrix !== "object") return 0;
      const totalRow = zoneMatrix.Total;
      if (totalRow && typeof totalRow.total === "number") return totalRow.total;
      let sum = 0;
      for (const row of Object.values(zoneMatrix)) {
        if (!row || typeof row !== "object") continue;
        if (typeof row.total === "number") sum += row.total;
      }
      return sum;
    }

    function hasLevel5(agentStats) {
      const zones = ["hs", "ls", "ns"];
      for (const z of zones) {
        const m = agentStats?.byZone?.[z];
        if (!m) continue;
        for (const row of Object.values(m)) {
          if (!row || typeof row !== "object") continue;
          const v = row[5];
          if (typeof v === "number" && v > 0) return true;
        }
      }
      return false;
    }

    function buildCorpTags(corp) {
      const tags = [];
      const typeLabel = corp?.type || corp?.faction || "";
      const corpIdNum = Number(corp?.corpId);
      const agentStats = agentsByCorp?.[String(corpIdNum)];

      const pe = inferPirateOrEmpire(typeLabel);
      if (pe) tags.push({ label: pe, cls: pe === "Pirate" ? "tag tag-pirate" : "tag tag-empire" });

      const fw = new Set([1000179, 1000180, 1000181, 1000182, 1000436, 1000437]);
      if (fw.has(corpIdNum)) tags.push({ label: "FW", cls: "tag tag-fw" });

      const hsCount = countZoneAgents(agentStats?.byZone?.hs);
      const lsCount = countZoneAgents(agentStats?.byZone?.ls);
      const nsCount = countZoneAgents(agentStats?.byZone?.ns);
      if (hsCount > 0) tags.push({ label: "HS", cls: "tag tag-hs" });
      if (lsCount > 0) tags.push({ label: "LS", cls: "tag tag-ls" });
      if (nsCount > 0) tags.push({ label: "NS", cls: "tag tag-ns" });

      if (hasLevel5(agentStats)) tags.push({ label: "LVL 5", cls: "tag tag-l5" });
      return tags;
    }

    const ALL_TAGS = ["Empire", "Pirate", "FW", "HS", "LS", "NS", "LVL 5"];

    function loadTagFilter() {
      try {
        const raw = localStorage.getItem("lp_corps_tag_filter_v1");
        const parsed = raw ? JSON.parse(raw) : null;
        const v = Array.isArray(parsed) ? parsed : (parsed && Array.isArray(parsed.tags) ? parsed.tags : null);
        if (v && v.length) return v;
      } catch { /* ignore */ }
      return ALL_TAGS.slice();
    }
    function saveTagFilter(tags) {
      localStorage.setItem("lp_corps_tag_filter_v1", JSON.stringify({ tags }));
    }

    let tagFilter = loadTagFilter();
    let tagDraft = tagFilter.slice();

    function updateTagButton() {
      if (!tagBtn) return;
      tagBtn.textContent = tagFilter.length ? `Tag Filter (${tagFilter.length})` : "Tag Filter";
    }

    function renderTagPanel() {
      const checks = Array.from(tagPanel.querySelectorAll("[data-check]"));
      for (const el of checks) {
        const tag = el.getAttribute("data-check") || "";
        el.textContent = tagDraft.includes(tag) ? "\u2713" : "";
      }
    }

    function openTagPanel() {
      tagDraft = tagFilter.slice();
      renderTagPanel();
      tagPanel.style.display = "block";
    }
    function closeTagPanel() {
      tagPanel.style.display = "none";
    }
    function toggleTagPanel() {
      if (tagPanel.style.display === "block") closeTagPanel();
      else {
        closeIskLpPanel();
        openTagPanel();
      }
    }

    function loadIskLpFilter() {
      try {
        const raw = localStorage.getItem("lp_corps_isklp_filter_v1");
        const parsed = raw ? JSON.parse(raw) : null;
        if (parsed && (parsed.min != null || parsed.max != null)) return parsed;
      } catch { /* ignore */ }
      return { min: null, max: null }; // Any
    }
    function saveIskLpFilter(v) {
      localStorage.setItem("lp_corps_isklp_filter_v1", JSON.stringify(v));
    }

    let isklpFilter = loadIskLpFilter();
    let isklpDraft = { ...isklpFilter };

    function updateIskLpButton() {
      if (!isklpBtn) return;
      let label = "ISK/LP";
      if (isklpFilter.min == null && isklpFilter.max == null) {
        // Any
      } else if (isklpFilter.max == null) {
        label += ` \u2265 ${isklpFilter.min}`;
      } else {
        label += ` ${isklpFilter.min ?? ""}-${isklpFilter.max ?? ""}`;
      }
      isklpBtn.textContent = label;
    }

    function renderIskLpPanel() {
      const checks = Array.from(isklpPanel.querySelectorAll("[data-check]"));
      for (const el of checks) el.textContent = "";
      const preset =
        (isklpDraft.min == null && isklpDraft.max == null) ? "any" :
        (isklpDraft.max == null && [1000, 2000, 3000].includes(Number(isklpDraft.min))) ? String(Number(isklpDraft.min)) :
        null;
      if (preset) {
        const el = isklpPanel.querySelector(`[data-check="${preset}"]`);
        if (el) el.textContent = "\u2713";
      }
      if (isklpMinBox) isklpMinBox.value = isklpDraft.min == null ? "" : String(isklpDraft.min);
      if (isklpMaxBox) isklpMaxBox.value = isklpDraft.max == null ? "" : String(isklpDraft.max);
    }

    function openIskLpPanel() {
      isklpDraft = { ...isklpFilter };
      renderIskLpPanel();
      isklpPanel.style.display = "block";
    }
    function closeIskLpPanel() {
      isklpPanel.style.display = "none";
    }

    function toggleIskLpPanel() {
      if (isklpPanel.style.display === "block") closeIskLpPanel();
      else {
        closeTagPanel();
        openIskLpPanel();
      }
    }

    function applyFilters() {
      const f = factionEl.value;

      return corps.filter(c => {
        const cfg = corpConfig?.corps?.[String(c.corpId)];
        if (cfg?.hide) return false;
        const type = String(c.type || c.faction || "");
        if (f && type !== f) return false;
        if (isklpFilter.min != null && (c.medianIskPerLp ?? -Infinity) < Number(isklpFilter.min)) return false;
        if (isklpFilter.max != null && (c.medianIskPerLp ?? Infinity) > Number(isklpFilter.max)) return false;
        if (tagFilter.length) {
          const tagSet = new Set(buildCorpTags(c).map((t) => t.label));
          let any = false;
          for (const sel of tagFilter) {
            if (tagSet.has(sel)) { any = true; break; }
          }
          if (!any) return false;
        }
        return true;
      });
    }

    function sortRows(rows) {
      const dir = sortState.dir === "asc" ? 1 : -1;
      return [...rows].sort((a,b)=>{
        if (sortState.key === "name") return String(a.name).localeCompare(String(b.name)) * dir;
        if (sortState.key === "agents") return ((agentsByCorp?.[String(a.corpId)]?.summary?.totalAgents ?? 0) - (agentsByCorp?.[String(b.corpId)]?.summary?.totalAgents ?? 0)) * dir;
        if (sortState.key === "corpId") return ((a.corpId ?? -Infinity) - (b.corpId ?? -Infinity)) * dir;
        if (sortState.key === "tags") return String(a.type || a.faction || "").localeCompare(String(b.type || b.faction || "")) * dir;
        if (sortState.key === "best") return ((a.bestIskPerLp ?? -Infinity) - (b.bestIskPerLp ?? -Infinity)) * dir;
        if (sortState.key === "median") return ((a.medianIskPerLp ?? -Infinity) - (b.medianIskPerLp ?? -Infinity)) * dir;
        if (sortState.key === "offers") return ((a.lpStoreCount ?? 0) - (b.lpStoreCount ?? 0)) * dir;
        return ((a.uniqueCount ?? 0) - (b.uniqueCount ?? 0)) * dir;
      });
    }

    function render() {
      const filtered = applyFilters();
      const sorted = sortRows(filtered);
      tbody.innerHTML = "";
      for (let i = 0; i < sorted.length; i++) {
        const c = sorted[i];
        const tr = document.createElement("tr");
        const logo = c.logoId ? `<img class="logo" src="https://images.evetech.net/corporations/${c.logoId}/logo?size=64" alt="${c.name}" referrerpolicy="no-referrer">` : "";
        const tags = buildCorpTags(c).map((t) => `<span class="pill ${t.cls}">${t.label}</span>`).join("");
        const agentCount = agentsByCorp?.[String(c.corpId)]?.summary?.totalAgents ?? 0;
        tr.innerHTML = `
          <td data-col="row">${i + 1}</td>
          <td data-col="corp" class="sticky-col"><a href="lp_corp.html?corp=${c.corpId}">${logo}${c.name}</a></td>
          <td data-col="tags"><span class="tag-cloud">${tags}</span></td>
          <td data-col="agents">${agentCount}</td>
          <td data-col="corpId">${c.corpId}</td>
          <td data-col="best">${c.bestIskPerLp != null ? Number(c.bestIskPerLp).toFixed(0) : "-"}</td>
          <td data-col="median">${c.medianIskPerLp != null ? Number(c.medianIskPerLp).toFixed(0) : "-"}</td>
          <td data-col="unique">${c.uniqueCount ?? 0}</td>
          <td data-col="offers">${c.lpStoreCount ?? 0}</td>
        `;
        const bestC = isklpColor(c.bestIskPerLp);
        const medC = isklpColor(c.medianIskPerLp);
        const bestTd = tr.querySelector('td[data-col="best"]');
        const medTd = tr.querySelector('td[data-col="median"]');
        if (bestTd && bestC) { bestTd.style.color = bestC; bestTd.style.fontWeight = "800"; }
        if (medTd && medC) { medTd.style.color = medC; medTd.style.fontWeight = "800"; }
        tbody.appendChild(tr);
      }
      if (columnsMgr) columnsMgr.apply();
    }

    async function loadData() {
      const [res, cfgRes, agentsRes] = await Promise.all([
        fetch("/json/lp_corps.json"),
        fetch("/config/lp_corps_config.json").catch(() => null),
        fetch("/json/lp_corp_agents.json").catch(() => null),
      ]);
      const data = await res.json();
      corps = data.corps || [];
      if (cfgRes && cfgRes.ok) {
        try { corpConfig = await cfgRes.json(); } catch { /* ignore */ }
      }
      if (agentsRes && agentsRes.ok) {
        try {
          const agentsJson = await agentsRes.json();
          agentsByCorp = agentsJson.corps || {};
        } catch { agentsByCorp = {}; }
      } else {
        agentsByCorp = {};
      }
      buildFactionOptions();
      updateTagButton();
      updateIskLpButton();
      render();
    }

    factionEl.addEventListener("change", render);

    tagBtn.addEventListener("click", toggleTagPanel);
    tagPanel.querySelectorAll(".opt").forEach((opt) => {
      opt.addEventListener("click", () => {
        const tag = opt.getAttribute("data-tag");
        if (!tag) return;
        if (tagDraft.includes(tag)) tagDraft = tagDraft.filter((t) => t !== tag);
        else tagDraft.push(tag);
        renderTagPanel();
      });
    });
    tagResetBtn.addEventListener("click", () => {
      tagDraft = [];
      renderTagPanel();
    });
    tagApplyBtn.addEventListener("click", () => {
      tagFilter = tagDraft.slice();
      saveTagFilter(tagFilter);
      updateTagButton();
      closeTagPanel();
      render();
    });

    isklpBtn.addEventListener("click", () => {
      if (isklpPanel.style.display === "block") closeIskLpPanel();
      else {
        closeTagPanel();
        openIskLpPanel();
      }
    });
    isklpPanel.querySelectorAll(".opt").forEach((opt) => {
      opt.addEventListener("click", () => {
        const p = opt.getAttribute("data-preset");
        if (!p) return;
        if (p === "any") isklpDraft = { min: null, max: null };
        else isklpDraft = { min: Number(p), max: null };
        renderIskLpPanel();
      });
    });
    isklpResetBtn.addEventListener("click", () => {
      isklpDraft = { min: null, max: null };
      renderIskLpPanel();
    });
    isklpApplyBtn.addEventListener("click", () => {
      const minRaw = (isklpMinBox?.value || "").trim();
      const maxRaw = (isklpMaxBox?.value || "").trim();
      const min = minRaw === "" ? null : Number(minRaw);
      const max = maxRaw === "" ? null : Number(maxRaw);
      isklpFilter = {
        min: (min != null && Number.isFinite(min)) ? min : null,
        max: (max != null && Number.isFinite(max)) ? max : null,
      };
      saveIskLpFilter(isklpFilter);
      updateIskLpButton();
      closeIskLpPanel();
      render();
    });
    if (isklpMinBox) isklpMinBox.addEventListener("input", () => {
      const v = isklpMinBox.value.trim();
      isklpDraft = { ...isklpDraft, min: v === "" ? null : Number(v) };
      renderIskLpPanel();
    });
    if (isklpMaxBox) isklpMaxBox.addEventListener("input", () => {
      const v = isklpMaxBox.value.trim();
      isklpDraft = { ...isklpDraft, max: v === "" ? null : Number(v) };
      renderIskLpPanel();
    });

    document.addEventListener("click", (e) => {
      const tWrap = document.getElementById("tagDropdown");
      const iWrap = document.getElementById("isklpDropdown");
      if (tWrap && !tWrap.contains(e.target)) closeTagPanel();
      if (iWrap && !iWrap.contains(e.target)) closeIskLpPanel();
    });
    document.querySelectorAll("th.sortable").forEach(th=>{
      th.addEventListener("click", ()=>{
        const key = th.dataset.sort;
        if (sortState.key === key) sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
        else { sortState.key = key; sortState.dir = "asc"; }
        render();
      });
    });

    loadData();
  </script>
</body>
</html>
